<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>项目自动化部署 | AlexTao 的 博客</title>
    <meta name="description" content="In doing we learn.">
    <link rel="icon" href="favicon.ico">
    
    <link rel="preload" href="/Weblog/assets/css/styles.bc17a3fe.css" as="style"><link rel="preload" href="/Weblog/assets/js/app.bc17a3fe.js" as="script"><link rel="preload" href="/Weblog/assets/js/47.a44c77ff.js" as="script"><link rel="prefetch" href="/Weblog/assets/css/16.styles.2339a627.css"><link rel="prefetch" href="/Weblog/assets/css/5.styles.c1152841.css"><link rel="prefetch" href="/Weblog/assets/css/7.styles.1f4a6057.css"><link rel="prefetch" href="/Weblog/assets/css/8.styles.5b6e1357.css"><link rel="prefetch" href="/Weblog/assets/js/0.a8dcd889.js"><link rel="prefetch" href="/Weblog/assets/js/10.bbae2931.js"><link rel="prefetch" href="/Weblog/assets/js/100.b8573d34.js"><link rel="prefetch" href="/Weblog/assets/js/101.abec8cfc.js"><link rel="prefetch" href="/Weblog/assets/js/102.79aa7798.js"><link rel="prefetch" href="/Weblog/assets/js/11.249c3d32.js"><link rel="prefetch" href="/Weblog/assets/js/12.6c4f9a9d.js"><link rel="prefetch" href="/Weblog/assets/js/13.9c3a7225.js"><link rel="prefetch" href="/Weblog/assets/js/14.8788763f.js"><link rel="prefetch" href="/Weblog/assets/js/15.c3d91b4b.js"><link rel="prefetch" href="/Weblog/assets/js/16.2339a627.js"><link rel="prefetch" href="/Weblog/assets/js/17.f68b5694.js"><link rel="prefetch" href="/Weblog/assets/js/18.1dc877c8.js"><link rel="prefetch" href="/Weblog/assets/js/19.8d3a8eb9.js"><link rel="prefetch" href="/Weblog/assets/js/2.adb0855b.js"><link rel="prefetch" href="/Weblog/assets/js/20.5b430c8f.js"><link rel="prefetch" href="/Weblog/assets/js/21.7570ba60.js"><link rel="prefetch" href="/Weblog/assets/js/22.c34e9396.js"><link rel="prefetch" href="/Weblog/assets/js/23.d89c70ce.js"><link rel="prefetch" href="/Weblog/assets/js/24.cc87bb5d.js"><link rel="prefetch" href="/Weblog/assets/js/25.024b7a56.js"><link rel="prefetch" href="/Weblog/assets/js/26.0d0e2118.js"><link rel="prefetch" href="/Weblog/assets/js/27.fd65c2c2.js"><link rel="prefetch" href="/Weblog/assets/js/28.e7e81b37.js"><link rel="prefetch" href="/Weblog/assets/js/29.d69a29c6.js"><link rel="prefetch" href="/Weblog/assets/js/3.9c9ae281.js"><link rel="prefetch" href="/Weblog/assets/js/30.e02a9f2a.js"><link rel="prefetch" href="/Weblog/assets/js/31.4d5d63f6.js"><link rel="prefetch" href="/Weblog/assets/js/32.2652c4b5.js"><link rel="prefetch" href="/Weblog/assets/js/33.f81118fb.js"><link rel="prefetch" href="/Weblog/assets/js/34.6539d2a9.js"><link rel="prefetch" href="/Weblog/assets/js/35.479b4b73.js"><link rel="prefetch" href="/Weblog/assets/js/36.24e9784f.js"><link rel="prefetch" href="/Weblog/assets/js/37.13a7e720.js"><link rel="prefetch" href="/Weblog/assets/js/38.57e7625b.js"><link rel="prefetch" href="/Weblog/assets/js/39.40ddc61b.js"><link rel="prefetch" href="/Weblog/assets/js/4.cb1adf5e.js"><link rel="prefetch" href="/Weblog/assets/js/40.4abade23.js"><link rel="prefetch" href="/Weblog/assets/js/41.03a22716.js"><link rel="prefetch" href="/Weblog/assets/js/42.4bf6acac.js"><link rel="prefetch" href="/Weblog/assets/js/43.7d75114c.js"><link rel="prefetch" href="/Weblog/assets/js/44.a74a0979.js"><link rel="prefetch" href="/Weblog/assets/js/45.224f0ae1.js"><link rel="prefetch" href="/Weblog/assets/js/46.716c0ee0.js"><link rel="prefetch" href="/Weblog/assets/js/48.c92bc6c3.js"><link rel="prefetch" href="/Weblog/assets/js/49.78d85a96.js"><link rel="prefetch" href="/Weblog/assets/js/5.c1152841.js"><link rel="prefetch" href="/Weblog/assets/js/50.65d4cc82.js"><link rel="prefetch" href="/Weblog/assets/js/51.dfe21a00.js"><link rel="prefetch" href="/Weblog/assets/js/52.a55d1d66.js"><link rel="prefetch" href="/Weblog/assets/js/53.24e5ba30.js"><link rel="prefetch" href="/Weblog/assets/js/54.3d44c9e1.js"><link rel="prefetch" href="/Weblog/assets/js/55.5509d3c1.js"><link rel="prefetch" href="/Weblog/assets/js/56.389f0044.js"><link rel="prefetch" href="/Weblog/assets/js/57.a6410cdf.js"><link rel="prefetch" href="/Weblog/assets/js/58.99de433a.js"><link rel="prefetch" href="/Weblog/assets/js/59.f362327e.js"><link rel="prefetch" href="/Weblog/assets/js/6.829d0e7e.js"><link rel="prefetch" href="/Weblog/assets/js/60.d8a731fd.js"><link rel="prefetch" href="/Weblog/assets/js/61.c32405a4.js"><link rel="prefetch" href="/Weblog/assets/js/62.2cf15697.js"><link rel="prefetch" href="/Weblog/assets/js/63.97976992.js"><link rel="prefetch" href="/Weblog/assets/js/64.df2f0acc.js"><link rel="prefetch" href="/Weblog/assets/js/65.0365fc24.js"><link rel="prefetch" href="/Weblog/assets/js/66.89f67105.js"><link rel="prefetch" href="/Weblog/assets/js/67.4d546178.js"><link rel="prefetch" href="/Weblog/assets/js/68.b3742591.js"><link rel="prefetch" href="/Weblog/assets/js/69.e2c032ec.js"><link rel="prefetch" href="/Weblog/assets/js/7.1f4a6057.js"><link rel="prefetch" href="/Weblog/assets/js/70.f262dfb0.js"><link rel="prefetch" href="/Weblog/assets/js/71.24d5a255.js"><link rel="prefetch" href="/Weblog/assets/js/72.c2fad7bd.js"><link rel="prefetch" href="/Weblog/assets/js/73.e3de86c7.js"><link rel="prefetch" href="/Weblog/assets/js/74.af039d36.js"><link rel="prefetch" href="/Weblog/assets/js/75.b5d26a4d.js"><link rel="prefetch" href="/Weblog/assets/js/76.5253b8d4.js"><link rel="prefetch" href="/Weblog/assets/js/77.13049fae.js"><link rel="prefetch" href="/Weblog/assets/js/78.732e7950.js"><link rel="prefetch" href="/Weblog/assets/js/79.91a95405.js"><link rel="prefetch" href="/Weblog/assets/js/8.5b6e1357.js"><link rel="prefetch" href="/Weblog/assets/js/80.60b08cac.js"><link rel="prefetch" href="/Weblog/assets/js/81.09852d19.js"><link rel="prefetch" href="/Weblog/assets/js/82.49b521d3.js"><link rel="prefetch" href="/Weblog/assets/js/83.681a706a.js"><link rel="prefetch" href="/Weblog/assets/js/84.ca93e702.js"><link rel="prefetch" href="/Weblog/assets/js/85.9813d878.js"><link rel="prefetch" href="/Weblog/assets/js/86.632f014f.js"><link rel="prefetch" href="/Weblog/assets/js/87.7737cd73.js"><link rel="prefetch" href="/Weblog/assets/js/88.1ec9c00d.js"><link rel="prefetch" href="/Weblog/assets/js/89.bbeb975f.js"><link rel="prefetch" href="/Weblog/assets/js/9.c685ce8f.js"><link rel="prefetch" href="/Weblog/assets/js/90.eda536dd.js"><link rel="prefetch" href="/Weblog/assets/js/91.391681fc.js"><link rel="prefetch" href="/Weblog/assets/js/92.dca04870.js"><link rel="prefetch" href="/Weblog/assets/js/93.01d44a2a.js"><link rel="prefetch" href="/Weblog/assets/js/94.f941a99a.js"><link rel="prefetch" href="/Weblog/assets/js/95.232bf755.js"><link rel="prefetch" href="/Weblog/assets/js/96.d381c6e0.js"><link rel="prefetch" href="/Weblog/assets/js/97.2a0ba8ba.js"><link rel="prefetch" href="/Weblog/assets/js/98.001e708c.js"><link rel="prefetch" href="/Weblog/assets/js/99.0ff7167d.js">
    <link rel="stylesheet" href="/Weblog/assets/css/styles.bc17a3fe.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/Weblog/" class="home-link router-link-active"><!----><span class="site-name">
      AlexTao 的 博客
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/Weblog/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Classify</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/Weblog/html_css/" class="nav-link">HTML/CSS</a></li><li class="dropdown-item"><!----><a href="/Weblog/javascript/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----><a href="/Weblog/node/" class="nav-link">Node.js</a></li><li class="dropdown-item"><!----><a href="/Weblog/frames/" class="nav-link">Frames</a></li><li class="dropdown-item"><!----><a href="/Weblog/tool/" class="nav-link">Tool</a></li><li class="dropdown-item"><!----><a href="/Weblog/currency/" class="nav-link router-link-active">Currency</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/AlexTaoClub" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Weblog/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Classify</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/Weblog/html_css/" class="nav-link">HTML/CSS</a></li><li class="dropdown-item"><!----><a href="/Weblog/javascript/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----><a href="/Weblog/node/" class="nav-link">Node.js</a></li><li class="dropdown-item"><!----><a href="/Weblog/frames/" class="nav-link">Frames</a></li><li class="dropdown-item"><!----><a href="/Weblog/tool/" class="nav-link">Tool</a></li><li class="dropdown-item"><!----><a href="/Weblog/currency/" class="nav-link router-link-active">Currency</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/AlexTaoClub" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>currency</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/Weblog/currency/" aria-current="page" class="sidebar-link">计算机</a></li><li><a href="/Weblog/currency/前端开发规范.html" class="sidebar-link">编码规范</a></li><li><a href="/Weblog/currency/DevOps.html" class="sidebar-link">DevOps</a></li><li><a href="/Weblog/currency/项目自动化部署.html" class="active sidebar-link">项目自动化部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Weblog/currency/项目自动化部署.html#ssh-copy-id" class="sidebar-link">ssh-copy-id</a></li><li class="sidebar-sub-header"><a href="/Weblog/currency/项目自动化部署.html#nginx-安装" class="sidebar-link">nginx 安装</a></li><li class="sidebar-sub-header"><a href="/Weblog/currency/项目自动化部署.html#nvm安装" class="sidebar-link">nvm安装</a></li><li class="sidebar-sub-header"><a href="/Weblog/currency/项目自动化部署.html#pm2" class="sidebar-link">PM2</a></li><li class="sidebar-sub-header"><a href="/Weblog/currency/项目自动化部署.html#私有化gitlab部署" class="sidebar-link">私有化gitlab部署</a></li><li class="sidebar-sub-header"><a href="/Weblog/currency/项目自动化部署.html#jenkins" class="sidebar-link">Jenkins</a></li><li class="sidebar-sub-header"><a href="/Weblog/currency/项目自动化部署.html#gitlab-jenkins-自动化部署" class="sidebar-link">gitlab + jenkins 自动化部署</a></li></ul></li><li><a href="/Weblog/currency/前端安全.html" class="sidebar-link">前端安全</a></li><li><a href="/Weblog/currency/前端算法.html" class="sidebar-link">前端算法</a></li><li><a href="/Weblog/currency/函数实现.html" class="sidebar-link">函数实现</a></li><li><a href="/Weblog/currency/通用函数.html" class="sidebar-link">通用函数</a></li><li><a href="/Weblog/currency/例题总结.html" class="sidebar-link">例题分析 </a></li></ul></div></li></ul></div><div class="page"><div class="content"><h3 id="项目自动化部署">项目自动化部署</h3><h2 id="ssh-copy-id">ssh-copy-id</h2><p>使用ssh去登陆到远程服务器的脚本</p><div class="language- extra-class"><pre class="language-text"><code>ssh-copy-id -i .ssh/id_rsa.pub  root@47.94.86.110
ssh root@47.94.86.110
</code></pre></div><h2 id="nginx-安装">nginx 安装</h2><p>安装服务器需要用到的模块</p><div class="language- extra-class"><pre class="language-text"><code>yum install -y gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel
</code></pre></div><p>提前创建好软件需要使用到的目录</p><div class="language- extra-class"><pre class="language-text"><code>mkdir -p /usr/local/nginx
mkdir -p /var/log/nginx
mkdir -p /var/temp/nginx
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>--prefix=/usr/local/nginx 指定服务安装到什么目录
--error-log-path=/var/log/nginx/error.log  指定错误日志存放地址 
/var/temp/nginx 存放代理过程中产生的临时文件
</code></pre></div><p>1.下载 openssl (到官网查看最新的版本，可以下载最新的)
wget -c http://www.openssl.org/source/openssl-1.0.1c.tar.gz
将 openssl 解压（记住解压后的目录）
2.到 nginx 官网下载最新的 nginx 源码， 解压 进入解压后的目录执行下面的代码，该命令是配置如何编译 nginx</p><p>wget -c http://nginx.org/download/nginx-1.14.2.tar.gz</p><div class="language- extra-class"><pre class="language-text"><code>tar -tzvf xxx.tar.gz
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>./configure --prefix=/usr/local/nginx \   
--pid-path=/var/local/nginx/nginx.pid \
--lock-path=/var/lock/nginx/nginx.lock \
--error-log-path=/var/log/nginx/error.log \
--http-log-path=/var/log/nginx/access.log \
--with-openssl=/root/nginx/openssl-1.0.1c \  # 这里使用 openssl 解压后的目录，需要修改！！！
--with-http_gzip_static_module \
--with-http_ssl_module \
--with-threads \
--with-debug \
--with-http_v2_module \
--with-stream \
--http-client-body-temp-path=/var/temp/nginx/client \
--http-proxy-temp-path=/var/temp/nginx/proxy \
--http-fastcgi-temp-path=/var/temp/nginx/fastcgi \
--http-uwsgi-temp-path=/var/temp/nginx/uwsgi \
--http-scgi-temp-path=/var/temp/nginx/scgi
编译
make
将编译后的结果进行安装
make install
</code></pre></div><h4 id="nginx-bash">nginx - bash</h4><div class="language- extra-class"><pre class="language-text"><code>#!/bin/bash
echo &quot;----------nginx config start----------&quot;
mkdir -p /usr/local/nginx
mkdir -p /var/log/nginx
mkdir -p /var/temp/nginx
cd ./nginx-1.14.2
./configure --prefix=/usr/local/nginx --pid-path=/var/local/nginx/nginx.pid --lock-path=/var/lock/nginx/nginx.lock --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --with-openssl=/openssl-1.1.0g --with-http_gzip_static_module --with-http_ssl_module --with-threads --with-debug --with-http_v2_module --with-stream --http-client-body-temp-path=/var/temp/nginx/client --http-proxy-temp-path=/var/temp/nginx/proxy --http-fastcgi-temp-path=/var/temp/nginx/fastcgi --http-uwsgi-temp-path=/var/temp/nginx/uwsgi --http-scgi-temp-path=/var/temp/nginx/scgi
make
make install
echo &quot;----------nginx config end----------&quot;
</code></pre></div><h4 id="nginx-未找到命令">Nginx-未找到命令</h4><div class="language- extra-class"><pre class="language-text"><code>vim /etc/profile

在profile文件末尾，加上一行
指向你的nginx的安装位置的sbin 目录
PATH=$PATH:/usr/local/nginx/sbin

重新加载环境
source /etc/profile   ===&gt;&gt;&gt; 

nginx -v : nginx version: nginx/1.14.2
</code></pre></div><h2 id="nvm安装">nvm安装</h2><p>先卸载,在安装</p><div class="language- extra-class"><pre class="language-text"><code>curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.2/install.sh | bash
</code></pre></div><p>通过cd ~/.nvm查看里面的所有文件，如果有nvm.sh就成功了</p><p>本地运行nvm还是出现command not found，那么请检查是否含有.bash_profile文件</p><div class="language- extra-class"><pre class="language-text"><code>ls -a | grep .bash_profile
</code></pre></div><p>没有bash_profile则新建文件，正常.bash_profile内容</p><div class="language- extra-class"><pre class="language-text"><code>export NVM_DIR=&quot;$HOME/.nvm&quot;
[ -s &quot;$NVM_DIR/nvm.sh&quot; ] &amp;&amp; \. &quot;$NVM_DIR/nvm.sh&quot;  # This loads nvm
[ -s &quot;$NVM_DIR/bash_completion&quot; ] &amp;&amp; \. &quot;$NVM_DIR/bash_completion&quot;  # This loads nvm bash_completion

source ~/.bashrc
</code></pre></div><p><strong>切换node默认版本</strong></p><div class="language- extra-class"><pre class="language-text"><code>nvm ls-remote
nvm install stable(最新稳定棒)
nvm alias default 版本号
</code></pre></div><h2 id="pm2">PM2</h2><div class="language- extra-class"><pre class="language-text"><code>npm install pm2 -g
</code></pre></div><h2 id="私有化gitlab部署">私有化gitlab部署</h2><p>http://www.git-scm.com.cn/1466.html</p><p>https://www.cnblogs.com/sunmmi/articles/5847785.html
https://blog.51cto.com/caiyuanji/2114796?cid=707746</p><h4 id="gitlab服务">gitlab服务</h4><div class="language- extra-class"><pre class="language-text"><code>yum install -y curl openssh-server openssh-clients postfix cronie policycoreutils-python
//10.x以后开始依赖policycoreutils-python
systemctl start postfix
systemctl enable postfix
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>wget -c https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-12.1.12-ce.0.el7.x86_64.rpm
rpm -ivh gitlab-ce-12.1.12-ce.0.el7.x86_64.rpm     
gitlab-ctl reconfigure
gitlab-ctl stop
gitlab-ctl start
gitlab-ctl restart
</code></pre></div><h4 id="注意事项">注意事项</h4><p><strong>配置修改需要重新生成配置文件，并且重启</strong></p><ul><li>gitlab自带的nginx 和 服务器已有的nginx冲突</li></ul><div class="language- extra-class"><pre class="language-text"><code>vim /etc/gitlab/gitlab.rb
nginx['listen_port'] = 8899 (line 1046)
external_url '域名:8899'
unicorn['port'] = 8877(可以不修改  line 695)  

vim /var/opt/gitlab/gitlab-rails/etc/unicorn.rb(可以不修改)
listen &quot;127.0.0.1:8877&quot;, :tcp_nopush =&gt; true

vim /var/opt/gitlab/nginx/conf/gitlab-http.conf
listen *:8899;
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>可以不用
cd /usr/local/nginx/conf
# gitlab socket 文件地址

upstream gitlab {
  # 7.x 版本在此位置
  # server unix:/var/opt/gitlab/gitlab-rails/tmp/sockets/gitlab.socket;
  # 8.0 位置
  server unix://var/opt/gitlab/gitlab-rails/sockets/gitlab.socket;
}

server {
  listen    8899;  #修改端口号（nginx需要访问的端口号和gitlab.rb中 external_url 端口号保持一致  ）
  server_name localhost;  
  server_tokens off;    # don't show the version number, a security best practice
  root /opt/gitlab/embedded/service/gitlab-rails/public;
  client_max_body_size 250m;
  #access_log  /var/log/gitlab/nginx/gitlab_access.log;
  #error_log  /var/log/gitlab/nginx/gitlab_error.log;
  location / {
    try_files $uri $uri/index.html $uri.html @gitlab;
  }
  location @gitlab {
    proxy_read_timeout 300; # Some requests take more than 30 seconds.
    proxy_connect_timeout 300; # Some requests take more than 30 seconds.
    proxy_redirect    off;
    proxy_set_header  X-Forwarded-Proto $scheme;
    proxy_set_header  Host              $http_host;
    proxy_set_header  X-Real-IP        $remote_addr;
    proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header  X-Frame-Options  SAMEORIGIN;
    proxy_pass   http://127.0.0.1:8877; #和gitlab.rb中unicorn['port']  端口号保持一致
  }
  location ~ ^/(assets)/  {
    root /opt/gitlab/embedded/service/gitlab-rails/public;
    expires max;
    add_header Cache-Control public;
  }
  error_page 502 /502.html;
}
</code></pre></div><ul><li>网络问题，国内用户，建议使用清华大学的镜像源进行安装</li></ul><div class="language- extra-class"><pre class="language-text"><code>vim /etc/yum.repos.d/gitlab-ce.repo
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>[gitlab-ce]
name=gitlab-ce
baseurl=http://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7
repo_gpgcheck=0
gpgcheck=0
enabled=1
gpgkey=https://packages.gitlab.com/gpg.key
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>yum makecache
yum install gitlab-ce
</code></pre></div><ul><li>命令（gitlab-ctl reconfigure 运行报错加 sudo）</li></ul><div class="language- extra-class"><pre class="language-text"><code>yum list | grep gitlab-ce

/etc/gitlab/gitlab.rb          #gitlab配置文件
/opt/gitlab                    #gitlab的程序安装目录
/var/opt/gitlab                #gitlab目录数据目录
/var/opt/gitlab/git-data       #存放仓库数据
gitlab-ctl reconfigure         #重新加载配置
gitlab-ctl status              #查看当前gitlab所有服务运行状态
gitlab-ctl stop                #停止gitlab服务
gitlab-ctl stop nginx          #单独停止某个服务
gitlab-ctl tail                #查看所有服务的日志

Gitlab的服务构成：
nginx：                 静态web服务器
gitlab-workhorse        轻量级反向代理服务器
logrotate              日志文件管理工具
postgresql             数据库
redis                  缓存数据库
sidekiq                用于在后台执行队列任务（异步执行）   
</code></pre></div><ul><li>Gitlab 汉化补丁( 新版本自带本地化 )</li></ul><div class="language- extra-class"><pre class="language-text"><code>cat /opt/gitlab/embedded/service/gitlab-rails/VERSION  ==&gt;&gt; 12.1.12     #查看安装版本，保证安装与汉化包版本一致

git clone https://gitlab.com/xhang/gitlab.git
# 克隆 GitLab.com 仓库
git clone https://gitlab.com/larryli/gitlab.git
＃或 Gitcafe.com 镜像，速度更快
git clone https://gitcafe.com/larryli/gitlab.git

cd gitlab
git branch -a
git diff remotes/origin/12-1-stable remotes/origin/12-1-stable-zh &gt; /tmp/12.1.12-zh.diff
gitlab-ctl stop

patch -d /opt/gitlab/embedded/service/gitlab-rails -p1 &lt; /tmp/10.0.0-zh.diff
或者 
# 应用汉化补丁
cd /opt/gitlab/embedded/service/gitlab-rails
git apply /tmp/12.12-zh.diff 


gitlab-ctl start
gitlab-ctl reconfigure
</code></pre></div><h2 id="jenkins">Jenkins</h2><h4 id="配置修改建议重启jenkins（service-jenkins-restart），感觉缓存严重">配置修改建议重启Jenkins（service jenkins restart），感觉缓存严重</h4><h3 id="安装">安装</h3><div class="language- extra-class"><pre class="language-text"><code>yum install java
java -version
sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat/jenkins.repo
sudo rpm --import https://pkg.jenkins.io/redhat/jenkins.io.key
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>rpm -ql jenkins                            查看安装目录
cat /etc/sysconfig/jenkins | more          查看Jenkins端口（默认8080，酌情修改）
service start jenkins                      启动Jenkins
</code></pre></div><h3 id="系统插件配置">系统插件配置</h3><h5 id="git-地址配置">Git - 地址配置</h5><div class="language- extra-class"><pre class="language-text"><code>首先服务器查看 git 
whereis git    --&gt;&gt; git: /usr/local/git /usr/local/git/bin/git /usr/local/git/libexec/git-core/git
选择带有 “/bin/git” 的路径  =&gt; /usr/local/git/bin/git
如果没有 “/bin/git” 则添加  =&gt; /usr/local/git =&gt; /usr/local/git/bin/git

系统设置 - 全局工具配置 - Git
Path to Git executable : /usr/local/git/bin/git
</code></pre></div><h5 id="git-parameter-参数构建化">Git Parameter - 参数构建化</h5><ul><li>常规参数配置</li></ul><div class="language- extra-class"><pre class="language-text"><code>常规参数配置 - 参数化构建过程

Git参数
名称  masterBranch ( 这个名称需要在源码管理Git处使用 $masterBranch )

🌰
name ： masterBranch
des  ： 分支
参数类型 ： 分支
默认值 ： origin/master

源码管理 - Git - Branches to build
指定分支 ：$masterBranch
</code></pre></div><h5 id="publish-over-ssh-服务器自动化">Publish over SSH - 服务器自动化</h5><ul><li>基础 - 配置项</li></ul><div class="language- extra-class"><pre class="language-text"><code>系统管理 - 系统配置 - Publish over SSH

Passphrase：密码（key的密码，没设置就是空）
Path to key：key文件（私钥）的路径
Key：将私钥复制到这个框中(path to key和key写一个即可)

SSH Servers的配置：
SSH Server Name：标识的名字
Hostname：需要连接ssh的主机名或ip地址（建议ip）
Username：用户名
Remote Directory：远程目录（用于接收Jenkins传过来的代码）

🌰：
Name                   aliyun
Hostname               47.94.86.110
Username               root
Remote Directory       /

配置测试
Test Configuration  ==&gt;&gt; Success
</code></pre></div><ul><li>构建后操作 - 配置项</li></ul><div class="language- extra-class"><pre class="language-text"><code>构建后操作 - 配置项 - Send build artifacts over SSH

Name:选择一个你配好的ssh服务器
Source files ：写你要传输的文件路径
Remove prefix ：要去掉的前缀，不写远程服务器的目录结构将和Source files写的一致
Remote directory ：写你要部署在远程服务器的那个目录地址下，不写就是SSH Servers配置里默认远程目录
Exec command ：传输完了要执行的命令，我这里执行了解压缩和解压缩完成后删除压缩包2个命令

🌰：
SSH Publishers
  SSH Scrver
  	Name ： aliyun
  Transfer Set
  	Source files ： build/build.tar.gz
  	Remove prefix ： build/
  	Remote directory ： /Alex/react-cli/
		Exec command ：  cd /Alex/react-cli
                     tar -zxvf build.tar.gz
                     rm -rf build.tar.gz
</code></pre></div><h5 id="nodejs-node-版本切换（解决yarn-npm-找不到的问题）">Nodejs - node 版本切换（解决yarn/npm 找不到的问题）</h5><ul><li>基础 - 配置项</li></ul><div class="language- extra-class"><pre class="language-text"><code>安装
系统管理 - 插件管理 - NodeJs

配置
系统设置 - 全局工具配置 - NodeJS  选择版本配置即可
</code></pre></div><ul><li>构建环境 - 配置项</li></ul><div class="language- extra-class"><pre class="language-text"><code>选中 Provide Node &amp; npm bin/ folder to PATH
选择 需要运行的Node环境
</code></pre></div><h3 id="注意事项-2">注意事项</h3><ul><li>git  ls-remote -h ...  什么的报错（原因 Jenkins git 版本太低）</li></ul><div class="language- extra-class"><pre class="language-text"><code>卸载服务器  git
yum remove -y git

重新源码安装 git
yum -y install libcurl-devel expat-devel curl-devel  gettext-devel openssl-devel zlib-devel
yum -y install  gcc perl-ExtUtils-MakeMaker
cd /
wget https://mirrors.edge.kernel.org/pub/software/scm/git/git-2.1.1.tar.gz
tar -zvxf git-2.1.1.tar.gz
cd git-2.1.1
make prefix=/usr/local/git all
make prefix=/usr/local/git install

添加环境变量
echo &quot;export PATH=$PATH:/usr/local/git/bin&quot; &gt;&gt; /etc/bashrc
source /etc/bashrc

查看最新 git 信息
git --version  --&gt;&gt; git version 2.1.1
whereis git    --&gt;&gt; git: /usr/local/git /usr/local/git/bin/git /usr/local/git/libexec/git-core/git
</code></pre></div><h2 id="gitlab-jenkins-自动化部署">gitlab + jenkins 自动化部署</h2><ul><li><p>新建Jenkns项目</p></li><li><p>常规参数配置</p></li><li><p>源码管理配置</p><ul><li>git  - 配置仓库地址 ， 添加帐号凭证及权限（passworld 或者 ssh）</li></ul></li><li><p>构建触发器</p><ul><li>Build when a change is pushed to GitLab.  URL: http://47.11.11.11./project/react-cli</li></ul><p>获取当前项目地址   http://47.11.11.11./project/react-cli</p><p>生成 Secret token(安全令牌)  12425b353j6lk3j6lk47l47l</p><ul><li>geilab 项目里面配置</li></ul><p>设置 - 集成  ==&gt;&gt; 将jenkins里获取的    url + Secret token  分别配置在gitlab中的 url Secret Token，及完成了gitlab Webhooks 配置</p></li><li><p>构建环境</p><p>配置node    <code>Provide Node &amp; npm bin/ folder to PATH</code></p></li><li><p>构建</p></li></ul><div class="language- extra-class"><pre class="language-text"><code>#!/bin/bash
yarn
yarn build
tar -zcvf build.tar.gz *
</code></pre></div></div><div class="page-edit"><!----><!----></div><!----></div></div></div>
    <script src="/Weblog/assets/js/app.bc17a3fe.js" defer></script><script src="/Weblog/assets/js/47.a44c77ff.js" defer></script>
  </body>
</html>
